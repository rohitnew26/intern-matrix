import{u as A,j as s}from"./index-iAiIFp0J.js";import{f as C,r as d}from"./router-Z28cWG60.js";import{f as R}from"./phonepeService-06ZOpbw5.js";import"./react-Bq7xPAhO.js";import"./ui-BpKHBLDN.js";const v=3e3,h=15,P="imx_phonepe_pending",k=()=>{const[p]=C(),t=d.useMemo(()=>p.get("tx"),[p]),[l,u]=d.useState("PENDING"),[S,n]=d.useState("Checking payment status..."),[I,E]=d.useState(0),{user:g}=A(),b=r=>{if(!r)return null;try{const o=localStorage.getItem(P);return(o?JSON.parse(o):[]).find(e=>e.tx===r)||null}catch(o){return console.warn("Unable to read pending PhonePe record",o),null}},N=r=>{if(r)try{const o=localStorage.getItem(P),e=(o?JSON.parse(o):[]).filter(a=>a.tx!==r);localStorage.setItem(P,JSON.stringify(e))}catch(o){console.warn("Unable to remove pending PhonePe record",o)}};d.useEffect(()=>{let r=!1;return(async()=>{if(!t){n("Missing transaction id."),u("ERROR");return}for(let c=1;c<=h;c+=1){try{const e=await R(t),a=e?.status||e?.code||e?.state,j=e?.message||"";if(r)return;if(E(c),n(j||`Attempt ${c} of ${h}`),a==="SUCCESS"||a==="PAYMENT_SUCCESS"||a==="COMPLETED"){u("SUCCESS"),n("Payment confirmed. Processing enrollment...");const i=b(t);if(console.log("[PhonePeReturn] Pending record:",i),console.log("[PhonePeReturn] User:",g),i){const y=i?.userId||g?.id;if(!y){console.warn("[PhonePeReturn] No user ID available"),n("Payment successful! Please sign in to complete your enrollment.");return}try{console.log("[PhonePeReturn] Verifying payment and enrolling via backend...");const x=await fetch("https://hhdronajrkxnetwqppkg.supabase.co/functions/v1/phonePP",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoZHJvbmFqcmt4bmV0d3FwcGtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNTY3MjIsImV4cCI6MjA3OTkzMjcyMn0.sIDB1ufidIyBxbzPXElYdmQr9uoy_igfVLaqxAHx5WU"},body:JSON.stringify({action:"verify-and-enroll",orderId:t,userId:y,course:i.course,priceCents:i.priceCents,currency:i.currency||"INR"})}),f=await x.json();if(!x.ok){console.error("[PhonePeReturn] Backend verification failed",f),n(`Payment confirmed, but enrollment failed: ${f.error||"Unknown error"}. Please contact support with transaction ID: ${t}`);return}console.log("[PhonePeReturn] Enrollment created via backend:",f),N(t),n("âœ… Payment confirmed! Enrollment complete. Check your dashboard.")}catch(m){console.error("[PhonePeReturn] Failed to verify and enroll",m),n(`Payment confirmed, but enrollment failed: ${m.message}. Contact support with transaction ID: ${t}`)}}else console.warn("[PhonePeReturn] No pending record found for transaction",t),n("Payment successful! However, we couldn't find your enrollment details. Please contact support with your transaction ID.");return}if(a==="FAILED"||a==="PAYMENT_FAILED"){u("FAILED"),n("Payment failed. Please retry.");return}}catch(e){if(r)return;n(e?.message||"Unable to check status.")}await new Promise(e=>setTimeout(e,v))}r||(u("PENDING"),n("Status pending. Please refresh after a minute if needed."))})(),()=>{r=!0}},[t]);const w=l==="SUCCESS"?"bg-green-100 text-green-800":l==="FAILED"||l==="ERROR"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800";return s.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:s.jsxs("div",{className:"w-full max-w-md bg-white shadow-lg rounded-2xl p-6 space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h1",{className:"text-lg font-semibold text-gray-900",children:"PhonePe Payment"}),s.jsx("span",{className:`text-xs font-semibold px-2 py-1 rounded-full ${w}`,children:l})]}),s.jsxs("div",{className:"space-y-2 text-sm text-gray-700",children:[s.jsx("p",{children:S}),t&&s.jsxs("p",{className:"text-xs text-gray-500",children:["Transaction ID: ",t]}),s.jsxs("p",{className:"text-xs text-gray-500",children:["Checks: ",I,"/",h]})]}),s.jsx("div",{className:"text-xs text-gray-500",children:"If your payment is successful but not reflected, please wait a minute and refresh this page."}),l==="SUCCESS"&&s.jsx("a",{href:"/dashboard?tab=courses",className:"block w-full text-center bg-yellow-500 text-black font-semibold py-2 rounded-lg hover:bg-yellow-600 transition-colors",children:"Go to Dashboard"})]})})};export{k as default};
